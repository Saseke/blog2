<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-3.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<table id="column_table" class="layui-table" lay-filter="columnlist"></table>

<script>
    layui.use('table', function () {
        var first = true;
        var table = layui.table;

        //第一个实例
        table.render({
            elem: '#column_table'
            , url: '/column/api/list' //数据接口
            , page: true //开启分页
            , cols: [[ //表头
                {field: 'id', title: 'ID', sort: true, fixed: 'left'}
                , {field: 'name', title: '栏目名', align: 'center'}
                , {field: '', title: "文章数", sort: true}
            ]]
            , limit: 15
            , limits: [10, 15, 20, 40, 80, 100]
            , done: function (res, curr, count) {
                if (first) {
                    layer.msg("加载完成 共" + count + "条数据");
                    first = false;
                }
            }
        });

        table.on('tool(columnlist)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var id = data.id;
            if (layEvent === 'detail') { //查看
                current_column_id = id;
                showAtRight("/fragment/articlelist.html");
            } else if (layEvent === 'del') { //删除
                layer.confirm('真的删除行么', function (index) {
                        deleteColumn(id);
                        obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                        layer.close(index);
                    }
                )
            } else if (layEvent === 'edit') { //编辑
                editColumn(id, obj);
            }

        })
        ;

    });
</script>

<script type="text/html" id="toolBar">
    <div class="layui-btn-group">
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="detail">
            <i class="layui-icon">&#xe705;</i>
        </button>
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="edit">
            <i class="layui-icon">&#xe642;</i>
        </button>
        <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="del">
            <i class="layui-icon">&#xe640;</i>
        </button>
    </div>

</script>

<script>
    function editColumn(id, obj) {
        layer.prompt({
                title: "please input new Column name",
                formType: 0
            },
            function (name, idx) {
                console.log(name);
                //同步更新缓存对应的值
                obj.update({
                    'name': name
                });
                console.log("update ...");
                layer.close(idx);
                $.ajax({
                    url: "/column/api/edit/" + id,
                    type: "post",
                    contentType: "application/json",
                    data: JSON.stringify({
                        "name": name
                    }),
                    error: function () {
                        layer.msg("server not response.")
                    },
                    success: function () {
                        layer.msg("Okay");
                    }
                });

            });
    }
</script>

<script>
    function deleteColumn(id) {
        $.ajax({
                url: "/column/api/delete/" + id,
                dataType: "json",
                type: "get",
                timeout: "3000",
                error: function () {
                    layer.msg("server no response : " + url);
                },
                success: function (data) {
                    if (data !== 1) {
                        layer.msg("delete failed.")
                    } else {
                        layer.msg("delete succeed.")
                    }
                }
            }
        )
    }

    function flushColumn() {
        showAtRight('/fragment/columnlist');
    }
</script>
</html>